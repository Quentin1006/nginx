worker_processes 1;

events {
    worker_connections 1024;
}


http {
    include mime.types;

    log_format main '[$time_local] "$request" $status';
    access_log /var/log/nginx/access.log main;


    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=mycache:10m max_size=10g;
    proxy_cache_key $uri$is_args$args;
    # proxy_cache_lock off;
    # proxy_cache_lock_age 5s;
    proxy_cache_methods GET HEAD;
    proxy_cache_valid 200 302 30s;

    # To use activate the ngx_cache_purge
    # WARNING: Never tested
    #
    # map $request_method $purge_method {
    #     PURGE 1;
    #     default 0;
    # }

    map $http_cache_control $should_bypass_cache {
        default 0;
        "no-cache" 1;
    }

    keepalive_timeout 65;

    upstream web {
        server localhost:8001;
        # server localhost:8002;
        # server localhost:8003;
    }

    server {
        listen 8001;
        server_name webserver1;
        location / {
            proxy_pass http://webserver:8001;
        }
    }

    # server {
    #     listen 8002;
    #     server_name webserver2;
    #     location / {
    #         proxy_pass http://webserver:8002;
    #     }
    # }

    # server {
    #     listen 8003;
    #     server_name webserver3;
    #     location / {
    #         proxy_pass http://webserver:8003;
    #     }
    # }
    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html index.htm;

        proxy_cache mycache;
        proxy_cache_bypass $should_bypass_cache;

        # To use activate the ngx_cache_purge
        # WARNING: Never tested
        #
        # location /purge {
        #     if ($purge_method = "PURGE") {
        #         proxy_cache_purge $purge_method;
        #         return 200 "Purged";
        #     }
        #     return 405;

        # }
        location /debug {
            add_header X-Debug "debugging";
            return 200 "$uri$is_args$args";
        }

        location /web {
            add_header X-Cache $upstream_cache_status;
            proxy_pass http://web;
        }


        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
        }
    }
}